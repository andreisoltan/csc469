#!/bin/bash

# Where are we? We expect some utilities to be present in this directory
CTX=`pwd`

# Logging paths
LOGCONTAINER=log
LOGPREFIX=parta
LOGDIR=$LOGPREFIX.`uname -n`.$$
LOGPATH=$LOGCONTAINER/$LOGDIR

# Logging set-up
mkdir -p $LOGPATH
pushd $LOGCONTAINER
  rm -f $LOGPREFIX.latest # old symlink
  ln -s $LOGDIR $LOGPREFIX.latest # new symlink
popd

# Begin experiments, we'll use CPU 0 arbitrarily. We're trying to run this on
# an unloaded machine anyway.
CPU=0

echo "Capturing platform data..." #############################################
./platform-info.sh >| $LOGPATH/platform_info.log

echo "Observing interval lengths..." ##########################################
INT_LOG=intervals
do-parta.sh -p $CPU -i -n 10000 | sort -n | uniq -c | awk '{print $2, $1}' \
    >| $LOGPATH/$INT_LOG.log

echo "Observing inactive periods... " #########################################
INACT_LOG=inactive_periods
do-parta.sh -p $CPU -t 600 -n 100 -m >| $LOGPATH/$INACT_LOG-ms.log
do-parta.sh -p $CPU -t 600 -n 100    >| $LOGPATH/$INACT_LOG-cycle.log

echo "Observing context switching... " ########################################
CONS_LOG=context_switch
do-parta.sh -p $CPU -c -t 600 -n 100 -m >| $LOGPATH/$CONS_LOG-ms.log
do-parta.sh -p $CPU -c -t 600 -n 100    >| $LOGPATH/$CONS_LOG-cycle.log


echo "Generating report..." ###################################################
pushd $LOGPATH
    # Pull in a copy of the current report.tex, generate our figures and create
    # the PDF

    cp -a $CTX/report.tex .
    $CTX/plot-parta.awk  $INACT_LOG-ms.log    | gnuplot
    $CTX/plot-parta.awk  $INACT_LOG-cycle.log | gnuplot

    $CTX/plot-parta.awk  $CONS_LOG-ms.log      | gnuplot
    $CTX/plot-parta.awk  $CONS_LOG-cycle.log   | gnuplot
    
    $CTX/plot-histogram.sh $INT_LOG.log $INT_LOG.tex

    latex report.tex
    latex report.tex
    dvips -o report.ps report.dvi
    ps2pdf report.ps
popd

# TODO: Complete the shell script to:
#           - run the experiment & get data (should we do the average of multiple
#            runs or something?)           
# 			- run gnuplot (or replacement)
# 			- display the resulting graph (?)
